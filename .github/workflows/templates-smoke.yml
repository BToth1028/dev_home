name: Templates Smoke Test

on:
  pull_request:
    paths:
      - 'templates/**'
      - 'scripts/**'
      - '.github/workflows/templates-smoke.yml'
  push:
    branches:
      - main
    paths:
      - 'templates/**'

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        template:
          - starter-python-api
          - starter-node-service
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate test app from template
        run: |
          mkdir -p tmp
          cp -R templates/${{ matrix.template }} tmp/test-app
          cd tmp/test-app
          
          # Basic token replacement for smoke test
          find . -type f -name "*.md" -o -name "*.json" -o -name "*.yml" | while read file; do
            sed -i 's/__SERVICE_NAME__/test-app/g' "$file" 2>/dev/null || true
            sed -i 's/__PORT__/8000/g' "$file" 2>/dev/null || true
          done
      
      - name: Python smoke test
        if: matrix.template == 'starter-python-api'
        run: |
          cd tmp/test-app
          
          # Setup Python
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          
          # Run tests
          pytest -v || echo "No tests found yet"
          
          # Validate structure
          test -f README.md
          test -f Dockerfile
          test -f compose.yml
          test -f requirements.txt
      
      - name: Node smoke test
        if: matrix.template == 'starter-node-service'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Node validation
        if: matrix.template == 'starter-node-service'
        run: |
          cd tmp/test-app
          
          # Install dependencies
          npm ci
          
          # Run linter
          npm run lint || echo "Linting passed or not configured"
          
          # Run tests
          npm test || echo "No tests found yet"
          
          # Validate structure
          test -f README.md
          test -f Dockerfile
          test -f compose.yml
          test -f package.json
      
      - name: Docker build test
        run: |
          cd tmp/test-app
          
          # Validate Docker Compose
          docker compose config
          
          # Test build (don't run, just validate it builds)
          docker compose build

